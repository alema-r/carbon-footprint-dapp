from web3 import Web3
from web3.middleware import geth_poa_middleware
import json
import time

baseURL = "http://127.0.0.1:22000"

def connnectionUtils(URL):
    web3 = Web3(Web3.HTTPProvider(URL))
    abiUser = json.loads(
        '[{"inputs":[{"internalType":"address","name":"defaultSupplier","type":"address"},{"internalType":"address","name":"defaultTransformer","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"userAddress","type":"address"},{"indexed":false,"internalType":"enum User.Role","name":"role","type":"uint8"}],"name":"newUser","type":"event"},{"inputs":[],"name":"CFaddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint16","name":"carbon_fp","type":"uint16"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bool","name":"isEnded","type":"bool"}],"name":"addTransformation","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"product_name","type":"string"},{"internalType":"uint256[]","name":"indexes","type":"uint256[]"}],"name":"createProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string[]","name":"name","type":"string[]"},{"internalType":"uint256[]","name":"lot","type":"uint256[]"},{"internalType":"uint256[]","name":"cf","type":"uint256[]"}],"name":"createRawMaterials","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"role","type":"uint8"}],"name":"createUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getProducts","outputs":[{"components":[{"internalType":"uint256","name":"productId","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"CF","type":"uint256"},{"internalType":"bool","name":"ended","type":"bool"}],"internalType":"struct ProductLibrary.Product[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getRawMaterials","outputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"lot","type":"uint256"},{"internalType":"address","name":"supplier","type":"address"},{"internalType":"uint256","name":"CF","type":"uint256"},{"internalType":"bool","name":"isUsed","type":"bool"}],"internalType":"struct ProductLibrary.RawMaterial[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"wallet","type":"address"}],"name":"getRole","outputs":[{"internalType":"enum User.Role","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getRole","outputs":[{"internalType":"enum User.Role","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferCP","outputs":[],"stateMutability":"nonpayable","type":"function"}]')
    abiCF = json.loads(
        '[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"userAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"cf","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"pId","type":"uint256"}],"name":"newCFAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"userAddress","type":"address"},{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":false,"internalType":"uint256","name":"lot","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cf","type":"uint256"}],"name":"newRawMaterialLotAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"userAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"pId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cf","type":"uint256"}],"name":"productIsFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"transformer","type":"address"},{"indexed":false,"internalType":"address","name":"supplier","type":"address"},{"indexed":false,"internalType":"uint256","name":"pId","type":"uint256"},{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":false,"internalType":"uint256","name":"lot","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cf","type":"uint256"}],"name":"rawMaterialIsUsed","type":"event"},{"inputs":[{"internalType":"uint256","name":"partialCF","type":"uint256"},{"internalType":"uint256","name":"pId","type":"uint256"},{"internalType":"bool","name":"isEnded","type":"bool"}],"name":"addCF","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string[]","name":"_rawMaterialName","type":"string[]"},{"internalType":"uint256[]","name":"_lot","type":"uint256[]"},{"internalType":"uint256[]","name":"_cf","type":"uint256[]"}],"name":"addRawMaterials","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllProducts","outputs":[{"components":[{"internalType":"uint256","name":"productId","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"CF","type":"uint256"},{"internalType":"bool","name":"ended","type":"bool"}],"internalType":"struct ProductLibrary.Product[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllRawMaterials","outputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"lot","type":"uint256"},{"internalType":"address","name":"supplier","type":"address"},{"internalType":"uint256","name":"CF","type":"uint256"},{"internalType":"bool","name":"isUsed","type":"bool"}],"internalType":"struct ProductLibrary.RawMaterial[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"pId","type":"uint256"}],"name":"getProductById","outputs":[{"components":[{"internalType":"uint256","name":"productId","type":"uint256"},{"internalType":"string","name":"name","type":"string"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"CF","type":"uint256"},{"internalType":"bool","name":"ended","type":"bool"}],"internalType":"struct ProductLibrary.Product","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_productName","type":"string"},{"internalType":"uint256[]","name":"_index","type":"uint256[]"}],"name":"mintProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"pId","type":"uint256"}],"name":"transferProduct","outputs":[],"stateMutability":"nonpayable","type":"function"}]')
    address = web3.toChecksumAddress(
        "0x9d13C6D3aFE1721BEef56B55D303B09E021E27ab")
    userContract = web3.eth.contract(address=address, abi=abiUser)
    addressCF = userContract.functions.CFaddress().call()
    CFContract = web3.eth.contract(address=addressCF, abi=abiCF)
    web3.middleware_onion.inject(geth_poa_middleware, layer=0)
    addresses = {'suppliers': [web3.toChecksumAddress(
        "0xe39aa631e6d13cd25afb81f78ab8ad9b398d1164"), web3.toChecksumAddress("0x6203c98392fe629e9e0f32e41be6d55a08e5cae4")]}
    addresses.update({'transformers': [web3.toChecksumAddress(
        "0xa97988296d696bd07fb37dd2179a9aa3a9af66fd"), web3.toChecksumAddress("0x0b7cb2ee5d883999d1a5030daf255aef6d9d87dd")]})
    print('starting seeding')
    for address in addresses['suppliers']:
        web3.eth.defaultAccount = address
        for i in range(1, 13):
            nome = f"MateriaPrima{i % 4}"
            lotto = int(i // 4)
            cf = (i//4)*100+(i%4)*10
            tx_hash = userContract.functions.createRawMaterials([nome], [lotto], [cf]).transact()
            web3.eth.wait_for_transaction_receipt(tx_hash)
            time.sleep(2)
    print('starting Minting Products')
    web3.eth.defaultAccount = addresses['transformers'][0]
    time.sleep(3)
    tx_hash = userContract.functions.createProduct("Prodotto1", [0, 23, 7]).transact()
    web3.eth.wait_for_transaction_receipt(tx_hash)
    time.sleep(3)
    tx_hash = userContract.functions.createProduct("Prodotto2", [1, 22, 20]).transact()
    web3.eth.wait_for_transaction_receipt(tx_hash)
    time.sleep(3)
    tx_hash = userContract.functions.createProduct("Prodotto3", [5, 9, 18]).transact()
    web3.eth.wait_for_transaction_receipt(tx_hash)
    time.sleep(3)
    web3.eth.defaultAccount = addresses['transformers'][1]
    tx_hash = userContract.functions.createProduct("Prodotto4", [15, 3, 4]).transact()
    web3.eth.wait_for_transaction_receipt(tx_hash)
    time.sleep(3)
    tx_hash = userContract.functions.createProduct("Prodotto5", [14, 21, 17]).transact()
    web3.eth.wait_for_transaction_receipt(tx_hash)
    time.sleep(3)
    tx_hash = userContract.functions.createProduct("Prodotto6", [11, 16, 19]).transact()
    web3.eth.wait_for_transaction_receipt(tx_hash)
    time.sleep(3)
    web3.eth.defaultAccount = addresses['transformers'][0]
    print("starting Transformations")
    for i in range(1, 7):
        if i > 3:
            web3.eth.default_account = addresses['transformers'][1]
        for j in range(1, 6):
            print("prodotto " + str(i) + " trasformazione: " + str(j))
            if (i == 3 or i == 6) and j == 5:
                userContract.functions.addTransformation(j * 5, i, True).transact()
            else:
                userContract.functions.addTransformation(j * 5, i, False).transact()
            time.sleep(2)


if __name__ == "__main__":
    connnectionUtils(baseURL)